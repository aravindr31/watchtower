---
import { Image } from 'astro:assets';
import InternalError from '../../../components/InternalError.astro';
import WatchListBtn from '../../../components/WatchListBtn.astro';
import Caurosel from '../../../components/Caurosel.astro';
import Recommendations from '../../../components/Recommendations.astro';

const { id } = Astro.params;
const {media_type}  =Astro.props;

const url = `${Astro.url.origin}/api/v1/${media_type}/getdetails?id=${id}`;

let content = null;
let isError = false;
let retires = 5
const fetchContentDetails = async () =>{
try{
const response = await fetch(url)
    if (!response.ok) {
        throw new Error(`Failed with status code ${response.status}: ${response.statusText}`)
    }
const data = await response.json()

content = {
    ...data,
    backdrop_path : data.backdrop_path && `https://image.tmdb.org/t/p/original${data?.backdrop_path}`  ,
    poster_path: data?.poster_path
        ? 'https://image.tmdb.org/t/p/w500/' + data?.poster_path
        : 'https://placehold.co/500x750/333333/EEE?font=montserrat&text=404',
    vote_average: (data?.vote_average),
    release_date: new Date(data?.release_date || data?.first_air_date).toLocaleDateString('en-us', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }),
    genres: data?.genres.map((g: { name: string; }) => g.name).join(', '),
    crew: data?.credits.crew.slice(0,3),
    cast: data?.credits.cast.slice(0,5).map((c: { profile_path: string; }) => ({
        ...c,
        profile_path: c.profile_path
            ? 'https://image.tmdb.org/t/p/w300/' + c.profile_path
            : 'https://placehold.co/300x450/333333/EEE?font=montserrat&text=404'
    })),
    images: data?.images.backdrops.slice(0, 9),
}
} catch(err){
    if (retires>0){
        retires--;
        console.log(`Retrying fetch.. Total retires left - ${retires}`);
        await fetchContentDetails();
    }else{
    console.log(err)
    isError = true}
}
}
await fetchContentDetails()
// console.log(content)
---

{isError && (
<InternalError/>
)}
{ !isError &&  content && (
    <div class="bg-cover bg-center mt-[-70px]" style={{ backgroundImage:`url(${content.backdrop_path})` }} transition:name="content-data" transition:animate="fade">
        <div class="backdrop-blur-lg bg-black/30 bg-gradient-to-t from-[#222222] to-transparent">
            <div class="container mx-auto px-4 py-32 flex flex-col items-center md:flex-row z-10 ">
                <div class="flex-none">
                    <Image inferSize={true} src={content.poster_path} alt={`${content.title || content.name} Poster`} class="content-poster w-64 lg:w-96 rounded-sm" id="content-poster"/>
                    <WatchListBtn media_type={media_type} id={content.id}>
                    <div class="flex w-full">
                        <div slot="fallback" class="mx-auto mt-2 justify-center items-center">
                            <svg class="w-20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 150"><path fill="none" stroke="#DC3636" stroke-width="13" stroke-linecap="round" stroke-dasharray="300 385" stroke-dashoffset="0" d="M275 75c0 31-27 50-50 50-58 0-92-100-150-100-28 0-50 22-50 50s23 50 50 50c58 0 92-100 150-100 24 0 50 19 50 50Z"><animate attributeName="stroke-dashoffset" calcMode="spline" dur="1" values="685;-685" keySplines="0 0 1 1" repeatCount="indefinite"></animate></path></svg>
                        </div>
                    </div>
                    </WatchListBtn>
                </div>
                <div class="md:ml-24">
                    <h2 class="text-3xl md:text-4xl mt-4 md:mt-0 mb-2 font-medium md:font-semibold text-center md:text-left">{content.title || content.name}</h2>
                    <div class="flex flex-wrap items-center text-gray-300 text-sm justify-center md:justify-start">
                        <svg class="fill-current text-red-500 w-4" viewBox="0 0 24 24">
                            <g data-name="Layer 2"><path d="M17.56 21a1 1 0 01-.46-.11L12 18.22l-5.1 2.67a1 1 0 01-1.45-1.06l1-5.63-4.12-4a1 1 0 01-.25-1 1 1 0 01.81-.68l5.7-.83 2.51-5.13a1 1 0 011.8 0l2.54 5.12 5.7.83a1 1 0 01.81.68 1 1 0 01-.25 1l-4.12 4 1 5.63a1 1 0 01-.4 1 1 1 0 01-.62.18z" data-name="star"/></g>
                        </svg>
                        <span class="ml-1">{parseFloat(content.vote_average.toFixed(1))}</span>
                        <span class="mx-2">|</span>
                        <span>{content.release_date}</span>
                        <span class="mx-2">|</span>
                        <span>{content.genres}</span>
                    </div>

                    <p class="text-gray-200 mt-8 text-justify ">{content.overview}</p>

                    <div class="mt-12">
                        <h4 class="text-white font-semibold">Featured Crew</h4>
                        <div class="flex mt-4">
                            {content?.crew.map((crew: { name: string; job: string }) => (
                                <div class="mr-8">
                                    <div class="text">{crew.name}</div>
                                    <div class="text-gray-400 text-sm">{crew.job}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div class="flex flex-row">
                        <div class="w-full sm:w-fit">
                            {content.videos.results.length && (
                                <div class="mt-12">
                                    <a
                                        class="flex items-center justify-center bg-[#dc3636] text-white rounded-sm font-normal px-5 py-4 hover:bg-[#f33e3e] transition ease-in-out duration-150"
                                        target="_blank"
                                        href={`https://www.youtube.com/embed/${content.videos.results[0].key}`}
                                    >
                                        <svg class="w-6 fill-current" viewBox="0 0 24 24">
                                            <path d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                                        </svg>
                                        <span class="ml-2 mx-4 text-white uppercase text-[15px] text-center font-medium tracking-[2px] transition-all duration-300 ease-in-out hover:tracking-[2.5px]">Play Trailer</span>
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </div>

    <div class="content-cast border-b border-gray-900 pt-2">
    {content.cast != null && content.cast.length >0  && (       
        <div class="container mx-auto px-4 py-16">
            <h2 class="text-2xl md:text-4xl font-medium md:font-semibold">Cast</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8">
            { content.cast.map((cast: { id: any; profile_path: string; name: string; character: unknown; }) => (
                <div class="mt-8 " transition:name="person-data">
                    <a href={`/people/${cast.id}`}>
                        <Image inferSize={true} id={`person-photo-${cast.id}`} src={cast.profile_path} alt={cast.name} class="thumbnail rounded-md hover:opacity-75 transition ease-in-out duration-150 shadow-xl" />
                    </a>
                    <div class="mt-2">
                        <a href={`/people/${cast.id}`} class="text-lg mt-2 hover:text-gray:300">{cast.name}</a>
                        <div class="text-sm text-gray-400">
                            {cast.character}
                        </div>
                    </div>
                </div>
            ))}
            </div>
        </div>
    )}
    </div> 
    <div class="border-b border-gray-900">
        <Caurosel images={content?.images} title || content.name={content?.title || content.name} server:defer>
            <div class="flex w-full mx-auto mt-8">
                <div slot="fallback" class="mx-auto justify-center items-center">
                    <svg class="w-20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 150"><path fill="none" stroke="#DC3636" stroke-width="13" stroke-linecap="round" stroke-dasharray="300 385" stroke-dashoffset="0" d="M275 75c0 31-27 50-50 50-58 0-92-100-150-100-28 0-50 22-50 50s23 50 50 50c58 0 92-100 150-100 24 0 50 19 50 50Z"><animate attributeName="stroke-dashoffset" calcMode="spline" dur="1" values="685;-685" keySplines="0 0 1 1" repeatCount="indefinite"></animate></path></svg>
                </div>
            </div>
        </Caurosel>
    </div>
    <div> 
        <Recommendations id={content.id} media={media_type} server:defer>
            <div class="flex w-full mx-auto mt-8">
                <div slot="fallback" class="mx-auto justify-center items-center">
                    <svg class="w-20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 150"><path fill="none" stroke="#DC3636" stroke-width="13" stroke-linecap="round" stroke-dasharray="300 385" stroke-dashoffset="0" d="M275 75c0 31-27 50-50 50-58 0-92-100-150-100-28 0-50 22-50 50s23 50 50 50c58 0 92-100 150-100 24 0 50 19 50 50Z"><animate attributeName="stroke-dashoffset" calcMode="spline" dur="1" values="685;-685" keySplines="0 0 1 1" repeatCount="indefinite"></animate></path></svg>
                </div>
            </div>
        </Recommendations>
    </div>
)}